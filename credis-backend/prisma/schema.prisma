datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

model Store {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String
  address       String?
  phoneNumber   String?  @map("phone_number")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  modifiedAt    DateTime @default(now()) @updatedAt @map("modified_at") @db.Timestamptz(6)

  storeOwners      StoreOwner[]
  customers        Customer[]
  credits          Credit[]
  customerBalances CustomerBalance[]
  smsNotifications SmsNotification[]
  smsSchedules     SmsSchedule[]

  @@map("stores")
}

model StoreOwner {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String   @unique @map("user_id") @db.Uuid
  name       String
  email      String   @unique
  storeId    String?  @map("store_id") @db.Uuid
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  modifiedAt DateTime @default(now()) @updatedAt @map("modified_at") @db.Timestamptz(6)

  store   Store?   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  credits Credit[]

  @@index([storeId])
  @@index([userId])
  @@map("store_owners")
}

model Admin {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String   @unique @map("user_id") @db.Uuid
  name         String
  email        String   @unique
  isSuperAdmin Boolean  @default(false) @map("is_super_admin")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  modifiedAt   DateTime @default(now()) @updatedAt @map("modified_at") @db.Timestamptz(6)

  @@index([userId])
  @@map("admins")
}

model Customer {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  storeId     String   @map("store_id") @db.Uuid
  name        String
  phoneNumber String   @map("phone_number")
  cidNumber   String?  @map("cid_number")
  address     String?
  email       String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  modifiedAt  DateTime @default(now()) @updatedAt @map("modified_at") @db.Timestamptz(6)

  store            Store             @relation(fields: [storeId], references: [id], onDelete: Cascade)
  credits          Credit[]
  customerBalances CustomerBalance[]
  smsNotifications SmsNotification[]
  smsSchedules     SmsSchedule[]

  @@unique([storeId, phoneNumber])
  @@index([storeId])
  @@index([phoneNumber])
  @@map("customers")
}

model Credit {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customerId      String   @map("customer_id") @db.Uuid
  storeId         String   @map("store_id") @db.Uuid
  amount          Decimal  @db.Decimal(12, 2)
  transactionType String   @map("transaction_type")
  transactionDate DateTime @default(now()) @map("transaction_date") @db.Timestamptz(6)
  description     String?
  journalNumber   String?  @map("journal_number")
  referenceNumber String?  @map("reference_number")
  createdBy       String?  @map("created_by") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  modifiedAt      DateTime @default(now()) @updatedAt @map("modified_at") @db.Timestamptz(6)

  customer   Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  store      Store       @relation(fields: [storeId], references: [id], onDelete: Cascade)
  storeOwner StoreOwner? @relation(fields: [createdBy], references: [id])

  @@index([customerId])
  @@index([storeId])
  @@index([transactionDate])
  @@map("credits")
}

model CustomerBalance {
  id                     String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customerId             String    @map("customer_id") @db.Uuid
  storeId                String    @map("store_id") @db.Uuid
  totalCreditGiven       Decimal   @default(0) @map("total_credit_given") @db.Decimal(12, 2)
  totalPaymentsReceived  Decimal   @default(0) @map("total_payments_received") @db.Decimal(12, 2)
  outstandingBalance     Decimal   @default(0) @map("outstanding_balance") @db.Decimal(12, 2)
  lastTransactionDate    DateTime? @map("last_transaction_date") @db.Timestamptz(6)
  createdAt              DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  modifiedAt             DateTime  @default(now()) @updatedAt @map("modified_at") @db.Timestamptz(6)

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  store    Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([customerId, storeId])
  @@index([customerId])
  @@map("customer_balances")
}

model SmsNotification {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customerId       String    @map("customer_id") @db.Uuid
  storeId          String    @map("store_id") @db.Uuid
  phoneNumber      String    @map("phone_number")
  message          String
  notificationType String    @map("notification_type")
  status           String    @default("pending")
  scheduledAt      DateTime? @map("scheduled_at") @db.Timestamptz(6)
  sentAt           DateTime? @map("sent_at") @db.Timestamptz(6)
  errorMessage     String?   @map("error_message")
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  modifiedAt       DateTime  @default(now()) @updatedAt @map("modified_at") @db.Timestamptz(6)

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  store    Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([status])
  @@map("sms_notifications")
}

model SmsSchedule {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  storeId          String    @map("store_id") @db.Uuid
  customerId       String?   @map("customer_id") @db.Uuid
  notificationType String    @default("monthly_reminder") @map("notification_type")
  dayOfMonth       Int?      @map("day_of_month")
  isActive         Boolean   @default(true) @map("is_active")
  lastSentAt       DateTime? @map("last_sent_at") @db.Timestamptz(6)
  nextScheduledAt  DateTime? @map("next_scheduled_at") @db.Timestamptz(6)
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  modifiedAt       DateTime  @default(now()) @updatedAt @map("modified_at") @db.Timestamptz(6)

  store    Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  customer Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([nextScheduledAt])
  @@map("sms_schedules")
}

model AuditLog {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  userType   String   @map("user_type")
  action     String
  entityType String   @map("entity_type")
  entityId   String?  @map("entity_id") @db.Uuid
  oldValues  Json?    @map("old_values")
  newValues  Json?    @map("new_values")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}